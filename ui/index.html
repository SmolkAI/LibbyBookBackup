<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libby Book Notes</title>
<style>
:root {
  --bg: #f5f5f5; --surface: #fff; --text: #1a1a1a; --text2: #555;
  --border: #e0e0e0; --accent: #2563eb; --accent2: #1d4ed8;
  --yellow: #FFB; --pink: #FFE0EC; --green: #DFC;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.dark {
  --bg: #111; --surface: #1e1e1e; --text: #e5e5e5; --text2: #999;
  --border: #333; --accent: #60a5fa; --accent2: #93bbfd;
  --yellow: #554d00; --pink: #552233; --green: #1a4d1a;
  --shadow: 0 1px 3px rgba(0,0,0,0.4);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Header */
.header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 1.2rem; white-space: nowrap; }
.search-box { flex: 1; min-width: 200px; max-width: 400px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; background: var(--bg); color: var(--text); }
.header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
select, button { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); font-size: 0.85rem; cursor: pointer; }
button:hover { background: var(--bg); }
.btn-active { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-active:hover { background: var(--accent2); }
.theme-toggle { font-size: 1.1rem; padding: 6px 8px; }
.result-count { font-size: 0.8rem; color: var(--text2); white-space: nowrap; }

/* Stats bar */
.stats-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; gap: 24px; flex-wrap: wrap; font-size: 0.85rem; color: var(--text2); }
.stat-item { display: flex; gap: 4px; }
.stat-value { font-weight: 600; color: var(--text); }

/* Grid */
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; padding: 20px; max-width: 1400px; margin: 0 auto; }
.card { background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
.card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.card-cover { width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block; }
.card-placeholder { width: 100%; aspect-ratio: 2/3; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3); padding: 12px; text-align: center; word-break: break-word; line-height: 1.2; }
.card-info { padding: 8px 10px; }
.card-title { font-size: 0.85rem; font-weight: 600; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.card-author { font-size: 0.75rem; color: var(--text2); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-meta { display: flex; gap: 6px; margin-top: 6px; align-items: center; flex-wrap: wrap; }
.badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
.badge-ebook { background: #dbeafe; color: #1e40af; }
.badge-audiobook { background: #fef3c7; color: #92400e; }
.dark .badge-ebook { background: #1e3a5f; color: #93bbfd; }
.dark .badge-audiobook { background: #4a3500; color: #fbbf24; }
.badge-hl { background: #fef9c3; color: #854d0e; font-size: 0.65rem; }
.dark .badge-hl { background: #4a3f00; color: #fde047; }
.badge-bm { background: #e0e7ff; color: #3730a3; font-size: 0.65rem; }
.dark .badge-bm { background: #1e1b4b; color: #a5b4fc; }

/* Detail overlay */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: start; justify-content: center; padding: 20px; overflow-y: auto; }
.detail { background: var(--surface); border-radius: 12px; max-width: 800px; width: 100%; margin-top: 20px; margin-bottom: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
.detail-header { display: flex; gap: 20px; padding: 24px; border-bottom: 1px solid var(--border); }
.detail-cover { width: 120px; flex-shrink: 0; border-radius: 6px; }
.detail-cover img { width: 100%; border-radius: 6px; }
.detail-meta { flex: 1; }
.detail-meta h2 { font-size: 1.3rem; margin-bottom: 4px; }
.detail-meta .author { color: var(--text2); margin-bottom: 8px; }
.detail-meta .meta-row { font-size: 0.85rem; color: var(--text2); margin-bottom: 4px; }
.detail-close { position: absolute; top: 8px; right: 12px; font-size: 1.5rem; cursor: pointer; color: var(--text2); background: none; border: none; }
.detail-body { padding: 20px 24px; position: relative; }
.section-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text2); margin: 16px 0 8px; }
.section-title:first-child { margin-top: 0; }

/* Progress bar */
.progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; background: var(--accent); border-radius: 3px; }

/* Highlights list */
.highlight { padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid; font-size: 0.9rem; line-height: 1.5; }
.highlight[data-color="#FFB"] { background: var(--yellow); border-color: #e6c200; }
.highlight[data-color="#DFC"] { background: var(--green); border-color: #4caf50; }
.highlight[data-color="#FFE0EC"] { background: var(--pink); border-color: #e91e63; }
.hl-chapter { font-size: 0.75rem; color: var(--text2); margin-bottom: 4px; font-weight: 600; }
.hl-note { font-style: italic; margin-top: 6px; color: var(--text2); font-size: 0.85rem; }
.hl-note::before { content: "Note: "; font-weight: 600; }

/* Bookmarks */
.bookmark { padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; background: var(--bg); font-size: 0.85rem; color: var(--text2); cursor: pointer; }
.bookmark.has-note { cursor: pointer; }
.bookmark.has-note .bm-header::before { content: '▸ '; font-size: 0.7rem; color: var(--text2); }
.bookmark.expanded .bm-header::before { content: '▾ '; }
.bm-header { display: flex; justify-content: space-between; }
.bm-note { display: none; margin-top: 6px; color: var(--text); font-style: italic; white-space: pre-wrap; }
.bookmark.expanded .bm-note { display: block; }

/* Circulation */
.circ-item { padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; background: var(--bg); font-size: 0.85rem; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 4px; }
.circ-activity { font-weight: 600; }

/* Loading */
.loading { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 1.1rem; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.hidden { display: none !important; }

/* Empty state */
.empty { text-align: center; padding: 60px 20px; color: var(--text2); }
.empty p { font-size: 1rem; margin-bottom: 8px; }

/* Mobile */
@media (max-width: 600px) {
  .header { padding: 10px 12px; gap: 8px; }
  .header h1 { font-size: 1rem; }
  .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 12px; }
  .detail-header { flex-direction: column; align-items: center; text-align: center; padding: 16px; }
  .detail-cover { width: 100px; }
  .detail-body { padding: 12px 16px; }
  .stats-bar { padding: 8px 12px; gap: 12px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>Libby Book Notes</h1>
  <input type="search" class="search-box" id="search" placeholder="Search titles, authors, highlights...">
  <div class="header-controls">
    <select id="filterFormat"><option value="">All Formats</option><option value="ebook">Ebook</option><option value="audiobook">Audiobook</option></select>
    <select id="filterLibrary"><option value="">All Libraries</option></select>
    <select id="filterContent"><option value="">All Books</option><option value="highlights">Has Highlights</option><option value="bookmarks">Has Bookmarks</option><option value="complete">100% Read</option></select>
    <select id="sortBy"><option value="lastActivity">Last Borrowed</option><option value="title">Title</option><option value="author">Author</option><option value="highlightCount">Most Highlights</option><option value="percent">Progress</option></select>
    <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">&#9790;</button>
    <span class="result-count" id="resultCount"></span>
  </div>
</div>

<div class="stats-bar" id="statsBar"></div>

<div class="loading" id="loadingMsg"><span class="spinner"></span>Loading books...</div>
<div class="grid hidden" id="grid"></div>
<div class="empty hidden" id="emptyMsg"><p>No books match your filters.</p></div>

<script>
const BOOKS_PATH = 'data/index.json';
let allBooks = [];
let stats = {};
let fuse = null;

// State
let currentQuery = '';
let currentFilters = { format: '', library: '', content: '' };
let currentSort = 'lastActivity';

// Elements
const $grid = document.getElementById('grid');
const $search = document.getElementById('search');
const $filterFormat = document.getElementById('filterFormat');
const $filterLibrary = document.getElementById('filterLibrary');
const $filterContent = document.getElementById('filterContent');
const $sortBy = document.getElementById('sortBy');
const $resultCount = document.getElementById('resultCount');
const $loading = document.getElementById('loadingMsg');
const $empty = document.getElementById('emptyMsg');
const $statsBar = document.getElementById('statsBar');
const $themeToggle = document.getElementById('themeToggle');

// Theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
  document.documentElement.classList.add('dark');
}
$themeToggle.addEventListener('click', () => {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
});

// Init
async function init() {
  try {
    const resp = await fetch(BOOKS_PATH);
    const data = await resp.json();
    allBooks = data.books;
    stats = data.stats;

    populateLibraryFilter();
    renderStats();

    // Load Fuse.js for fuzzy search
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js';
    script.onload = () => {
      fuse = new Fuse(allBooks, {
        keys: [{ name: 'title', weight: 2 }, { name: 'author', weight: 1.5 }, { name: 'publisher', weight: 0.5 }],
        threshold: 0.35,
        ignoreLocation: true,
      });
      render();
    };
    script.onerror = () => render(); // fallback without fuzzy search
    document.head.appendChild(script);
  } catch (e) {
    $loading.textContent = 'Error loading data. Run: python3 scripts/build_index.py';
    console.error(e);
  }
}

function populateLibraryFilter() {
  const libs = new Set();
  allBooks.forEach(b => b.libraries.forEach(l => libs.add(l)));
  [...libs].sort().forEach(lib => {
    const opt = document.createElement('option');
    opt.value = lib;
    opt.textContent = lib;
    $filterLibrary.appendChild(opt);
  });
}

function renderStats() {
  const items = [
    ['Books', stats.totalBooks],
    ['Highlights', stats.totalHighlights],
    ['Bookmarks', stats.totalBookmarks],
  ];
  Object.entries(stats.formats).forEach(([k, v]) => items.push([k.charAt(0).toUpperCase() + k.slice(1) + 's', v]));
  $statsBar.innerHTML = items.map(([label, val]) =>
    `<div class="stat-item"><span class="stat-value">${val}</span> ${label}</div>`
  ).join('');
}

function getFiltered() {
  let books = allBooks;

  // Search
  if (currentQuery && fuse) {
    books = fuse.search(currentQuery).map(r => r.item);
  } else if (currentQuery) {
    const q = currentQuery.toLowerCase();
    books = books.filter(b => b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q));
  }

  // Filters
  if (currentFilters.format) books = books.filter(b => b.format === currentFilters.format);
  if (currentFilters.library) books = books.filter(b => b.libraries.includes(currentFilters.library));
  if (currentFilters.content === 'highlights') books = books.filter(b => b.highlightCount > 0);
  if (currentFilters.content === 'bookmarks') books = books.filter(b => b.bookmarkCount > 0);
  if (currentFilters.content === 'complete') books = books.filter(b => b.percent && b.percent >= 0.99);

  // Sort
  if (!currentQuery || currentSort !== 'lastActivity') {
    books = [...books].sort((a, b) => {
      switch (currentSort) {
        case 'title': return (a.title || '').localeCompare(b.title || '');
        case 'author': return (a.author || '').localeCompare(b.author || '');
        case 'highlightCount': return (b.highlightCount || 0) - (a.highlightCount || 0);
        case 'percent': return (b.percent || 0) - (a.percent || 0);
        default: return (b.lastActivity || 0) - (a.lastActivity || 0);
      }
    });
  }

  return books;
}

function render() {
  $loading.classList.add('hidden');
  const books = getFiltered();
  $resultCount.textContent = `${books.length} book${books.length !== 1 ? 's' : ''}`;
  $empty.classList.toggle('hidden', books.length > 0);
  $grid.classList.toggle('hidden', books.length === 0);

  $grid.innerHTML = books.map(b => {
    const coverHtml = b.coverUrl
      ? `<img class="card-cover" src="${escHtml(b.coverUrl)}" alt="" loading="lazy" onerror="this.outerHTML=placeholderHtml('${escAttr(b.title)}','${escAttr(b.coverColor)}')">`
      : placeholderHtml(b.title, b.coverColor);
    const badges = [];
    badges.push(`<span class="badge badge-${b.format || 'ebook'}">${b.format || '?'}</span>`);
    if (b.highlightCount) badges.push(`<span class="badge badge-hl">${b.highlightCount} hl</span>`);
    if (b.bookmarkCount) badges.push(`<span class="badge badge-bm">${b.bookmarkCount} bm</span>`);
    return `<div class="card" data-file="${escAttr(b.file)}">${coverHtml}<div class="card-info"><div class="card-title">${escHtml(b.title)}</div><div class="card-author">${escHtml(b.author)}</div><div class="card-meta">${badges.join('')}</div></div></div>`;
  }).join('');
}

function placeholderHtml(title, color) {
  const bg = color || '#6366f1';
  const initials = (title || '?').split(/\s+/).slice(0, 3).map(w => w[0]).join('');
  return `<div class="card-placeholder" style="background:${escAttr(bg)}">${escHtml(initials)}</div>`;
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function escAttr(s) { return (s || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;'); }

// Events
let searchTimeout;
$search.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentQuery = $search.value.trim(); render(); }, 200); });
$filterFormat.addEventListener('change', () => { currentFilters.format = $filterFormat.value; render(); });
$filterLibrary.addEventListener('change', () => { currentFilters.library = $filterLibrary.value; render(); });
$filterContent.addEventListener('change', () => { currentFilters.content = $filterContent.value; render(); });
$sortBy.addEventListener('change', () => { currentSort = $sortBy.value; render(); });

// Detail view
$grid.addEventListener('click', async (e) => {
  const card = e.target.closest('.card');
  if (!card) return;
  const file = card.dataset.file;
  const book = allBooks.find(b => b.file === file);
  if (!book) return;
  await showDetail(book);
});

async function showDetail(book) {
  // Load full book JSON
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `<div class="detail" style="position:relative"><button class="detail-close">&times;</button><div style="text-align:center;padding:40px"><span class="spinner"></span> Loading...</div></div>`;
  document.body.appendChild(overlay);
  document.body.style.overflow = 'hidden';
  overlay.addEventListener('click', (e) => { if (e.target === overlay) closeDetail(overlay); });
  overlay.querySelector('.detail-close').addEventListener('click', () => closeDetail(overlay));

  try {
    // Books are in ../books/ relative to ui/
    const resp = await fetch(`../books/${encodeURIComponent(book.file)}`);
    const data = await resp.json();
    renderDetail(overlay.querySelector('.detail'), book, data);
  } catch (e) {
    overlay.querySelector('.detail').innerHTML = `<div style="padding:24px">Error loading book data: ${escHtml(e.message)}</div>`;
  }
}

function closeDetail(overlay) {
  overlay.remove();
  document.body.style.overflow = '';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const overlay = document.querySelector('.overlay');
    if (overlay) closeDetail(overlay);
  }
});

function renderDetail(container, book, data) {
  const rj = data.readingJourney;
  const highlights = data.highlights || [];
  const bookmarks = data.bookmarks || [];
  const circulation = data.circulation || [];
  const percent = rj.percent;

  const coverImg = rj.cover?.url
    ? `<img src="${escHtml(rj.cover.url)}" alt="" style="width:100%;border-radius:6px">`
    : `<div class="card-placeholder" style="background:${escAttr(rj.cover?.color || '#6366f1')};width:120px;height:180px;border-radius:6px;font-size:1.5rem">${escHtml((rj.title?.text || '?').split(/\s+/).slice(0,3).map(w=>w[0]).join(''))}</div>`;

  let html = `<button class="detail-close">&times;</button>`;
  html += `<div class="detail-header"><div class="detail-cover">${coverImg}</div><div class="detail-meta">`;
  html += `<h2>${escHtml(rj.title?.text)}</h2>`;
  html += `<div class="author">${escHtml(rj.author)}</div>`;
  html += `<div class="meta-row">${escHtml(rj.publisher)} &middot; ${escHtml(rj.isbn)}</div>`;
  html += `<div class="meta-row"><span class="badge badge-${rj.cover?.format || 'ebook'}">${rj.cover?.format || '?'}</span>`;
  html += ` ${highlights.length} highlights &middot; ${bookmarks.length} bookmarks</div>`;
  if (percent != null) {
    const pct = Math.round(percent * 100);
    html += `<div class="meta-row">Progress: ${pct}%</div>`;
    html += `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
  }
  if (rj.title?.url) {
    html += `<div class="meta-row"><a href="${escAttr(rj.title.url)}" target="_blank">View on Libby</a></div>`;
  }
  html += `</div></div>`;

  html += `<div class="detail-body">`;

  // Highlights
  if (highlights.length) {
    html += `<div class="section-title">Highlights (${highlights.length})</div>`;
    highlights.forEach(h => {
      const color = h.color || '#FFB';
      html += `<div class="highlight" data-color="${escAttr(color)}">`;
      if (h.chapter) html += `<div class="hl-chapter">${escHtml(h.chapter)} &middot; ${Math.round((h.percent || 0) * 100)}%</div>`;
      html += escHtml(h.quote);
      if (h.note) html += `<div class="hl-note">${escHtml(h.note)}</div>`;
      html += `</div>`;
    });
  }

  // Bookmarks
  if (bookmarks.length) {
    html += `<div class="section-title">Bookmarks (${bookmarks.length})</div>`;
    bookmarks.forEach(bm => {
      const date = bm.timestamp ? new Date(bm.timestamp).toLocaleDateString() : '';
      const hasNote = bm.note ? ' has-note' : '';
      html += `<div class="bookmark${hasNote}" onclick="this.classList.toggle('expanded')"><div class="bm-header"><span>${escHtml(bm.chapter || 'Bookmark')}</span><span>${Math.round((bm.percent || 0) * 100)}% &middot; ${date}</span></div>`;
      if (bm.note) html += `<div class="bm-note">${escHtml(bm.note)}</div>`;
      html += `</div>`;
    });
  }

  // Circulation
  if (circulation.length) {
    html += `<div class="section-title">History (${circulation.length})</div>`;
    circulation.forEach(c => {
      const date = c.timestamp ? new Date(c.timestamp).toLocaleDateString() : '';
      html += `<div class="circ-item"><span><span class="circ-activity">${escHtml(c.activity)}</span> at ${escHtml(c.library?.text || '')}</span><span>${date}</span></div>`;
    });
  }

  html += `</div>`;
  container.innerHTML = html;
  container.querySelector('.detail-close').addEventListener('click', () => {
    const overlay = container.closest('.overlay');
    if (overlay) closeDetail(overlay);
  });
}

init();
</script>
</body>
</html>
